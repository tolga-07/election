<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Turkey SMD District Builder</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0e14;
      --panel:#0f1522;
      --panel2:#0c1220;
      --text:#e9eefb;
      --muted:#aab6d6;
      --line:rgba(255,255,255,.10);
      --chip:rgba(255,255,255,.08);
      --good:#67e8a8;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 40px rgba(0,0,0,.40);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(72,121,255,.18), transparent 55%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,72,72,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:650;
      letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: conic-gradient(from 180deg, #60a5fa, #fb7185, #34d399, #fbbf24, #60a5fa);
      box-shadow:0 0 0 3px rgba(255,255,255,.05);
    }
    .sub{
      font-weight:500;
      color:var(--muted);
      margin-left:6px;
      font-size:12px;
    }
    .top-actions{display:flex; gap:8px; align-items:center;}
    button, .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16);}
    button:active{transform: translateY(1px);}
    button.primary{
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.28);
    }
    button.danger{
      background: rgba(251,113,133,.14);
      border-color: rgba(251,113,133,.22);
    }
    button.ghost{
      background: transparent;
    }
    .wrap{
      height: calc(100% - 56px);
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:12px;
      padding:12px;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height:0;
    }
    .panel .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hd .title{font-weight:700;}
    .panel .bd{padding:12px; overflow:auto; min-height:0;}
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .row{display:flex; gap:8px; align-items:center;}
    .row + .row{margin-top:8px;}
    .grow{flex:1}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 8px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:2px 6px;
      border-radius:7px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size:12px;
    }
    input[type="file"]{display:none;}
    label.filebtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px dashed rgba(255,255,255,.22);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      color:var(--text);
      background: rgba(255,255,255,.03);
      font-weight:650;
    }
    label.filebtn:hover{background: rgba(255,255,255,.06);}
    .small{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--line); margin:10px 0;}
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
    }
    .card .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .badge{
      width:12px;height:12px;border-radius:4px;
      border:1px solid rgba(255,255,255,.18);
      flex:none;
    }
    .district-name{font-weight:700}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .mini{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:8px;
    }
    .pill{
      font-size:12px;
      padding:5px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:700;}
    .pill.win{border-color: rgba(103,232,168,.22); background: rgba(103,232,168,.10); color: rgba(226,255,242,.95);}
    .pill.warn{border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.10); color: rgba(255,248,230,.95);}
    .pill.bad{border-color: rgba(251,113,133,.22); background: rgba(251,113,133,.10); color: rgba(255,235,240,.95);}
    .mapWrap{
      position:relative;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    #map{height:100%; width:100%;}
    .mapHUD{
      position:absolute;
      left:10px; top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:500;
      pointer-events:none;
    }
    .mapHUD .chip{pointer-events:none;}
    .footerHUD{
      position:absolute;
      left:10px; bottom:10px;
      right:10px;
      z-index:500;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .footerHUD .chip{pointer-events:none; max-width: 55%;}
    .note{
      color:var(--muted);
      font-size:12px;
    }
    .tinyBtns{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .tinyBtns button{
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
      font-weight:700;
    }
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background: rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      box-shadow: var(--shadow);
      max-width: min(520px, calc(100vw - 28px));
      display:none;
      z-index:9999;
    }
    .toast .t{font-weight:750;margin-bottom:4px}
    .toast .b{color:var(--muted);font-size:12px;white-space:pre-wrap}
    .toast.show{display:block;}
    .leaflet-container{background: #0a0f1a;}
    .leaflet-control-zoom a{
      background: rgba(0,0,0,.35) !important;
      border:1px solid rgba(255,255,255,.14) !important;
      color: var(--text) !important;
    }
    .leaflet-tooltip{
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      border-radius:10px;
      padding:8px 10px;
      box-shadow: var(--shadow);
    }
    @media (max-width: 1100px){
      .wrap{grid-template-columns: 340px 1fr;}
      .wrap .panel.right{display:none;}
    }
    @media (max-width: 820px){
      body{overflow:auto;}
      .wrap{grid-template-columns: 1fr; height:auto;}
      .mapWrap{height: 62vh;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>Turkey SMD District Builder <span class="sub">click districts, win seats, pretend it’s “neutral”</span></div>
    </div>
    <div class="top-actions">
      <button class="ghost" id="btnUndo" title="Undo last assignment">Undo</button>
      <button class="ghost" id="btnRedo" title="Redo">Redo</button>
      <button class="ghost" id="btnPaint" title="Paint mode (drag to assign)">Paint: Off</button>
      <button class="danger" id="btnClear">Clear plan</button>
      <button class="primary" id="btnExport">Export</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Left panel -->
    <div class="panel">
      <div class="hd">
        <div class="title">Build districts</div>
        <div class="chip"><span class="kbd">Click</span>/<span class="kbd">Drag</span> assign · <span class="kbd">Shift</span> unassign · <span class="kbd">Ctrl/Cmd</span>+Z undo</div>
      </div>
      <div class="bd">
        <div class="row">
          <button class="primary" id="btnNewDistrict">+ New district</button>
          <button id="btnDeleteDistrict" class="danger" title="Delete active district">Delete</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="chip" id="activeChip">Active: —</div>
          <div class="chip" id="assignedChip">Assigned: 0</div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between; align-items:end;">
          <div>
            <div style="font-weight:750">Votes data</div>
            <div class="hint">Load vote shares (or votes) per ilçe. All areas should be present in the dataset.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px; gap:10px;">
          <label class="filebtn">
            <input id="fileVotes" type="file" accept=".json,.csv" />
            Import JSON/CSV
          </label>
          <button id="btnLoadSample">Load sample</button>
        </div>

        <div class="row">
          <div class="small" id="dataStatus">No data loaded.</div>
          <div class="small" style="margin-top:4px; color:var(--muted);">Plans autosave in your browser.</div>
        </div>

        <div class="sep"></div>
        <div style="font-weight:750">District list</div>
        <div class="hint">Each district is one seat. Winner-takes-all. Civilization collapses quietly.</div>
        <div class="list" id="districtList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- Map -->
    <div class="mapWrap">
      <div id="map"></div>
      <div class="mapHUD">
        <div class="chip" id="mapChip">Loading map…</div>
      </div>
      <div class="footerHUD">
        <div class="chip" id="hoverChip">Hover an ilçe</div>
        <div class="chip" id="seatChip">Seats: —</div>
      </div>
    </div>

    <!-- Right panel -->
    <div class="panel right">
      <div class="hd">
        <div class="title">Seat tally</div>
        <div class="chip" id="smdCountChip">0 districts</div>
      </div>
      <div class="bd">
        <div id="seatTally" class="list"></div>
        <div class="sep"></div>
        <div class="note" id="importReport"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t" id="toastT"></div>
    <div class="b" id="toastB"></div>
  </div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=1) => (isFinite(n) ? (+n).toFixed(d) : "—");

  const TURKISH_MAP = new Map([
    ["İ","i"],["I","i"],["ı","i"],["Ş","s"],["ş","s"],["Ğ","g"],["ğ","g"],
    ["Ü","u"],["ü","u"],["Ö","o"],["ö","o"],["Ç","c"],["ç","c"]
  ]);

  function normName(s){
    if(!s) return "";
    let out = "";
    for(const ch of String(s).trim()){
      out += TURKISH_MAP.get(ch) ?? ch;
    }
    out = out.toLowerCase();
    try { out = out.normalize("NFD").replace(/\p{Diacritic}/gu,""); } catch(e){}
    out = out.replace(/[^a-z0-9]+/g," ").trim().replace(/\s+/g," ");
    return out;
  }

  function districtColor(id){
    if(!id) return "rgba(255,255,255,.08)";
    const hue = (id * 47) % 360;
    return `hsla(${hue}, 78%, 58%, 0.72)`;
  }
  function districtStroke(id){
    if(!id) return "rgba(255,255,255,.16)";
    const hue = (id * 47) % 360;
    return `hsla(${hue}, 82%, 64%, 0.95)`;
  }

  function showToast(title, body, ms=3800){
    $("toastT").textContent = title;
    $("toastB").textContent = body || "";
    $("toast").classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => $("toast").classList.remove("show"), ms);
  }

  function download(filename, text){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1200);
  }

  // ---------- State ----------
  let map, geoLayer;
  const featuresByKey = new Map();       // key -> feature + layer
  const nameIndex = new Map();           // normalized name -> [keys]
  const assignments = new Map();         // key -> districtId
  const undoStack = [];                  // [{key, prev, next}]
  const unitData = new Map();            // key -> { votes: {party:val}, weight:number, rawName:string }
  let parties = [];                      // array of party/candidate names
  let districts = [];                    // [{id, name}]
  let activeDistrictId = 0;
  let lastHoverKey = null;

  // ---------- Map setup ----------
  map = L.map("map", { zoomControl:true, preferCanvas:true });
  const tiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OpenStreetMap &copy; CARTO"
  });
  tiles.addTo(map);

  function styleForKey(key){
    const did = assignments.get(key) || 0;
    return {
      weight: did ? 1.8 : 1.0,
      color: districtStroke(did),
      opacity: did ? 0.95 : 0.55,
      fillColor: districtColor(did),
      fillOpacity: did ? 0.78 : 0.18
    };
  }

  function refreshLayerStyle(key){
    const obj = featuresByKey.get(key);
    if(obj?.layer) obj.layer.setStyle(styleForKey(key));
  }

  function refreshAllStyles(){
    for(const [key,obj] of featuresByKey){
      if(obj.layer) obj.layer.setStyle(styleForKey(key));
    }
  }

  function tooltipHTML(key){
    const obj = featuresByKey.get(key);
    const name = obj?.feature?.properties?.name ?? "—";
    const did = assignments.get(key) || 0;

    const v = getUnitVotes(key);
    let winner = null, wv = -Infinity;
    for(const p of parties){
      const val = v.votes[p] ?? 0;
      if(val > wv){ wv = val; winner = p; }
    }
    const lines = [];
    if(parties.length){
      const top = parties
        .map(p => ({p, v: +(v.votes[p] ?? 0)}))
        .sort((a,b)=>b.v - a.v)
        .slice(0, 4);
      for(const t of top){
        lines.push(`${t.p}: ${fmt(t.v,1)}%`);
      }
    } else {
      lines.push("No vote data loaded.");
    }

    return `<div style="min-width:220px">
      <div style="font-weight:800; margin-bottom:2px">${escapeHtml(name)}</div>
      <div style="color:rgba(233,238,251,.85); font-size:12px; margin-bottom:6px">
        ${did ? `District <b>#${did}</b>` : `Unassigned`}
      </div>
      <div style="color:rgba(170,182,214,.95); font-size:12px; white-space:pre-line">${escapeHtml(lines.join("\n"))}</div>
      ${winner ? `<div style="margin-top:8px; font-size:12px; color:rgba(233,238,251,.95)">
        Winner: <b>${escapeHtml(winner)}</b> (${fmt(wv,1)}%)
      </div>` : ``}
    </div>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function onFeature(feature, layer){
    const key = feature.properties?.["@id"] || feature.id || String(Math.random());
    featuresByKey.set(key, {feature, layer});

    const nm = normName(feature.properties?.name || "");
    if(nm){
      if(!nameIndex.has(nm)) nameIndex.set(nm, []);
      nameIndex.get(nm).push(key);
    }

    layer.on("mouseover", (ev) => {
      lastHoverKey = key;
      $("hoverChip").textContent = feature.properties?.name || "—";
      if(paintMode && mouseDown){
        paintAtKey(key, ev.originalEvent);
        return;
      }
      layer.bindTooltip(tooltipHTML(key), {sticky:true, direction:"auto", opacity:1}).openTooltip();
      // highlight a bit
      layer.setStyle({weight: 2.6, opacity: 1});
    });

    layer.on("mousedown", (ev) => {
      if(!paintMode) return;
      if(ev.originalEvent && ev.originalEvent.button !== 0) return;
      mouseDown = true;
      paintAtKey(key, ev.originalEvent);
    });
    layer.on("mouseout", () => {
      if(!paintMode){
        layer.closeTooltip();
      }
      refreshLayerStyle(key);
    });
    layer.on("click", (ev) => {
      const shift = ev.originalEvent && ev.originalEvent.shiftKey;
      if(shift){
        setAssignment(key, 0, true);
        return;
      }
      if(!activeDistrictId){
        showToast("No active district", "Create a district first.");
        return;
      }
      setAssignment(key, activeDistrictId, true);
    });
  }

  async function loadMap(){
    $("mapChip").textContent = "Loading map…";
    const res = await fetch("turkey-admin-level-6-3.geojson");
    if(!res.ok) throw new Error("Could not load turkey-admin-level-6-3.geojson");
    const gj = await res.json();

    geoLayer = L.geoJSON(gj, {
      filter: (feat) => {
        const t = feat?.geometry?.type;
        return t === "Polygon" || t === "MultiPolygon";
      },
      style: (feat) => {
        const key = feat.properties?.["@id"] || feat.id || "";
        return styleForKey(key);
      },
      onEachFeature: onFeature
    }).addTo(map);

    map.fitBounds(geoLayer.getBounds(), {padding:[10,10]});
    $("mapChip").textContent = "Map ready";
    showToast("Ready", "Click to assign. Shift+click to unassign.");
    refreshUI();
  }

  // ---------- Districting ----------
  function nextDistrictId(){
    let max = 0;
    for(const d of districts) max = Math.max(max, d.id);
    return max + 1;
  }

  function addDistrict(){
    const id = nextDistrictId();
    districts.push({id, name:`District ${id}`});
    activeDistrictId = id;
    saveState();
    refreshUI();
    showToast("District created", `Active district is now #${id}.`);
  }

  function deleteActiveDistrict(){
    if(!activeDistrictId) return;
    const id = activeDistrictId;
    // unassign all units in it
    const changed = [];
    for(const [key, did] of assignments){
      if(did === id){
        changed.push(key);
      }
    }
    for(const key of changed){
      setAssignment(key, 0, false);
    }
    districts = districts.filter(d => d.id !== id);
    activeDistrictId = districts.length ? districts[districts.length - 1].id : 0;
    undoStack.length = 0;
    redoStack.length = 0;
    saveState();
    refreshAllStyles();
    refreshUI();
    showToast("District deleted", `Removed district #${id}.`);
  }

  function setAssignment(key, did, pushUndo){
    const prev = assignments.get(key) || 0;
    if(prev === did) return;
    assignments.set(key, did);
    if(did === 0) assignments.delete(key);
    refreshLayerStyle(key);
    if(pushUndo){
      undoStack.push({key, prev, next: did});
      if(undoStack.length > 5000) undoStack.shift();
      redoStack.length = 0;
    }
    saveState();
    refreshUI();
  }

  function undo(){
    const op = undoStack.pop();
    if(!op) return;
    const {key, prev, next} = op;
    assignments.set(key, prev);
    if(prev === 0) assignments.delete(key);
    refreshLayerStyle(key);
    redoStack.push({key, prev, next});
    saveState();
    refreshUI();
  }

  

  function redo(){
    const op = redoStack.pop();
    if(!op) return;
    const {key, prev, next} = op;
    assignments.set(key, next);
    if(next === 0) assignments.delete(key);
    refreshLayerStyle(key);
    undoStack.push({key, prev, next});
    saveState();
    refreshUI();
  }
function clearPlan(){
    assignments.clear();
    undoStack.length = 0;
    redoStack.length = 0;
    saveState();
    refreshAllStyles();
    refreshUI();
    showToast("Cleared", "All assignments removed.");
  }

  // ---------- Votes ----------
  function parseNumber(x){
    if(x === null || x === undefined) return NaN;
    const s = String(x).trim();
    if(!s) return NaN;
    // handle "61,4" or "61.4" or "12 345"
    const t = s.replace(/\./g, ".").replace(/\s+/g,"").replace(",",".");
    const n = Number(t);
    return isFinite(n) ? n : NaN;
  }

  function detectPartiesFromRows(rows){
    const ignore = new Set([
      "Ilce Id","Ilce Adi","Belde Adi",
      "Kayitli Secmen Sayisi","Oy Kullanan Secmen Sayisi","Gecerli Oy Toplami","Sandik Sayisi",
      "id","name","province","il","ilce","district","weight","population","registered","valid"
    ]);
    const keys = new Map(); // key -> numericCount
    for(const r of rows){
      for(const k of Object.keys(r)){
        if(ignore.has(k)) continue;
        const v = parseNumber(r[k]);
        if(isFinite(v)){
          keys.set(k, (keys.get(k)||0) + 1);
        }
      }
    }
    // keep columns that look numeric in enough rows
    const out = [...keys.entries()]
      .filter(([,cnt]) => cnt >= Math.max(2, Math.floor(rows.length * 0.2)))
      .map(([k]) => k);
    return out;
  }

  function getUnitVotes(key){
    if(parties.length === 0){
      return {votes:{}, weight:1, from:"none"};
    }
    const d = unitData.get(key);
    if(d){
      return {votes: d.votes, weight: d.weight || 1, from:"data"};
    }
    // With full datasets, missing units should be treated as missing (not imputed).
    return {votes:{}, weight:1, from:"missing"};
  }

  function normalizeShares(obj){
    const total = Object.values(obj).reduce((a,b)=>a + (isFinite(b)?+b:0), 0);
    if(total <= 0) return obj;
    const out = {};
    for(const [k,v] of Object.entries(obj)) out[k] = (+v) * (100/total);
    return out;
  }

  function setParties(newParties){
    // Preserve order, dedupe, trim
    const seen = new Set();
    parties = [];
    for(const raw of (newParties || [])){
      const p = String(raw ?? "").trim();
      if(!p || seen.has(p)) continue;
      seen.add(p);
      parties.push(p);
    }
    refreshUI();
  }

  async function loadSample(){
    const res = await fetch("Adana2023pres1.json");
    if(!res.ok) throw new Error("Could not load Adana2023pres1.json");
    const rows = await res.json();
    importRows(rows, {source:"Adana2023pres1.json"});
  }

  function importRows(rows, meta={source:"import"}){
    if(!Array.isArray(rows) || rows.length === 0){
      showToast("Import failed", "File had no rows.");
      return;
    }
    // drop empty header row if present
    rows = rows.filter(r => {
      const nm = r["Ilce Adi"] ?? r.name ?? r.ilce ?? r.district ?? "";
      return String(nm).trim().length > 0;
    });

    const detected = detectPartiesFromRows(rows);
    if(!detected.length){
      showToast("Import incomplete", "Could not detect party columns. Include numeric columns per party.");
      return;
    }
    setParties(detected);

    // build match report
    const missing = [];
    const ambiguous = [];
    let matched = 0;

    for(const r of rows){
      const rawName = (r["Ilce Adi"] ?? r.name ?? r.ilce ?? r.district ?? "").toString();
      const nm = normName(rawName);
      const keys = nameIndex.get(nm) || [];
      if(keys.length === 0){
        missing.push(rawName);
        continue;
      }
      if(keys.length > 1){
        ambiguous.push(`${rawName} → ${keys.length} matches`);
      }
      const key = keys[0];
      const votes = {};
      for(const p of parties){
        const v = parseNumber(r[p]);
        votes[p] = isFinite(v) ? v : 0;
      }
      // interpret as shares or votes? We accept either; for winner it doesn't matter.
      // For aggregation, if they look like shares (sum <= 120), we treat as shares.
      const sum = Object.values(votes).reduce((a,b)=>a+b,0);
      const isShare = sum <= 120.0;
      const normVotes = isShare ? normalizeShares(votes) : votes;

      const weightCand = parseNumber(r["Gecerli Oy Toplami"]) || parseNumber(r["Oy Kullanan Secmen Sayisi"]) || parseNumber(r["Kayitli Secmen Sayisi"]);
      const weight = isFinite(weightCand) && weightCand > 0 ? weightCand : 1;

      unitData.set(key, {votes: normVotes, weight, rawName});
      matched++;
    }

        const totalMap = featuresByKey.size || 0;
    let missingOnMap = 0;
    if(totalMap){
      for(const k of featuresByKey.keys()){
        if(!unitData.has(k)) missingOnMap++;
      }
    }
    const mapSuffix = totalMap ? ("/" + totalMap) : "";
    $("dataStatus").textContent =
      `Loaded ${matched}${mapSuffix} areas from ${meta.source}. Parties: ${parties.length}.` +
      (missingOnMap ? ` Missing on map: ${missingOnMap}.` : "");
    const reportLines = [];
    if(ambiguous.length) reportLines.push(`Ambiguous name matches: ${ambiguous.length} (first match used).`);
    if(missing.length) reportLines.push(`Unmatched names: ${missing.length}.`);
    const sampleMissing = missing.slice(0, 14).map(x=>`- ${x}`).join("\n");
    $("importReport").textContent =
      reportLines.join("\n") + (missing.length ? `\n\nUnmatched examples:\n${sampleMissing}${missing.length>14?`\n… +${missing.length-14} more`:``}` : "");

    showToast("Data loaded", `${matched} matched. Unmatched areas are left as missing.`);
    refreshUI();
  }

  function importCSV(text){
    // naive CSV parser: comma or semicolon; first row headers
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if(lines.length < 2) throw new Error("CSV had too few lines.");
    const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(sep);
      const r = {};
      for(let j=0;j<headers.length;j++){
        r[headers[j]] = (cols[j] ?? "").trim();
      }
      rows.push(r);
    }
    importRows(rows, {source:"CSV"});
  }

  // ---------- Results ----------
  function aggregateDistrict(did){
    const members = [];
    for(const [key, d] of assignments){
      if(d === did) members.push(key);
    }
    if(!members.length) return null;

    if(!parties.length){
      return {members, shares:{}, weightSum: members.length, winner:null, winnerVal:NaN};
    }

    const totals = {};
    let wsum = 0;
    for(const p of parties) totals[p] = 0;

    for(const key of members){
      const u = getUnitVotes(key);
      const w = u.weight || 1;
      wsum += w;
      for(const p of parties){
        totals[p] += (u.votes[p] ?? 0) * w;
      }
    }
    const shares = {};
    for(const p of parties){
      shares[p] = wsum ? (totals[p] / wsum) : 0;
    }
    // ensure shares sum to ~100 when it's shares
    const sharesNorm = normalizeShares(shares);

    let winner=null, winnerVal=-Infinity;
    for(const p of parties){
      const v = sharesNorm[p] ?? 0;
      if(v > winnerVal){ winnerVal=v; winner=p; }
    }
    return {members, shares: sharesNorm, weightSum: wsum, winner, winnerVal};
  }

  function computeSeatTally(){
    const tally = new Map(); // party -> seats
    for(const p of parties) tally.set(p, 0);

    for(const d of districts){
      const agg = aggregateDistrict(d.id);
      if(!agg || !agg.winner) continue;
      tally.set(agg.winner, (tally.get(agg.winner)||0) + 1);
    }
    return tally;
  }

  function refreshUI(){
    // chips
    $("activeChip").textContent = activeDistrictId ? `Active: #${activeDistrictId}` : "Active: —";
    const assignedCount = assignments.size;
    $("assignedChip").textContent = `Assigned: ${assignedCount}`;
    $("smdCountChip").textContent = `${districts.length} districts`;

    // district list
    const list = $("districtList");
    list.innerHTML = "";
    if(!districts.length){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<div style="color:var(--muted); font-size:12px">No districts yet. Hit <b>New district</b>, then start clicking.</div>`;
      list.appendChild(c);
    } else {
      for(const d of districts){
        const agg = aggregateDistrict(d.id);
        const members = agg?.members?.length ?? 0;

        // margin-ish indicator
        let topLine = "";
        let pillClass = "pill";
        if(agg?.winner){
          const sorted = parties.map(p => ({p, v: agg.shares[p] ?? 0})).sort((a,b)=>b.v-a.v);
          const a = sorted[0], b = sorted[1] || {v:0};
          const margin = a.v - b.v;
          topLine = `${a.p} +${fmt(margin,1)}`;
          pillClass = margin < 2.0 ? "pill warn" : "pill win";
        } else {
          topLine = members ? "No vote data" : "Empty";
          pillClass = members ? "pill warn" : "pill";
        }

        const card = document.createElement("div");
        card.className = "card";
        const active = d.id === activeDistrictId;
        card.innerHTML = `
          <div class="top">
            <div style="display:flex; align-items:center; gap:8px;">
              <div class="badge" style="background:${districtColor(d.id)}"></div>
              <div>
                <div class="district-name">${escapeHtml(d.name)}${active ? " <span class='pill' style='margin-left:6px; color:var(--text)'>active</span>" : ""}</div>
                <div class="meta">${members} ilçe</div>
              </div>
            </div>
            <div class="tinyBtns">
              <button class="ghost" data-act="use" data-id="${d.id}">Use</button>
            </div>
          </div>
          <div class="mini">
            <div class="${pillClass}">${escapeHtml(topLine)}</div>
            ${agg?.winner ? `<div class="pill"><strong>${escapeHtml(agg.winner)}</strong> ${fmt(agg.winnerVal,1)}%</div>` : ``}
          </div>
        `;
        card.querySelectorAll("button[data-act='use']").forEach(btn => {
          btn.addEventListener("click", () => {
            activeDistrictId = +btn.dataset.id;
            refreshUI();
          });
        });
        list.appendChild(card);
      }
    }

    // seat tally (right panel)
    const tally = computeSeatTally();
    const seatsDiv = $("seatTally");
    seatsDiv.innerHTML = "";
    if(!parties.length){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<div style="color:var(--muted); font-size:12px">Load vote data to see winners and seats.</div>`;
      seatsDiv.appendChild(c);
      $("seatChip").textContent = `Seats: ${districts.length}`;
    } else {
      const rows = [...tally.entries()].sort((a,b)=>b[1]-a[1]);
      const totalSeats = districts.length;
      $("seatChip").textContent = `Seats: ${totalSeats} · decided: ${rows.reduce((a,[,s])=>a+s,0)}`;
      for(const [p,s] of rows){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800">${escapeHtml(p)}</div>
            <div class="pill"><strong>${s}</strong> seat${s===1?"":"s"}</div>
          </div>
        `;
        seatsDiv.appendChild(card);
      }
    }
  }

  // ---------- Export ----------
  function exportPlan(){
    const plan = {
      meta: {
        kind: "turkey-smd-district-plan",
        created_at: new Date().toISOString(),
        districts: districts.length,
        parties
      },
      districts: districts.map(d => ({...d})),
      assignments: [...assignments.entries()].map(([key,did]) => ({
        unit_id: key,
        name: featuresByKey.get(key)?.feature?.properties?.name ?? null,
        district_id: did
      }))
    };
    download("turkey_smd_plan.json", JSON.stringify(plan, null, 2));
    showToast("Exported", "Saved plan as turkey_smd_plan.json");
  }

  
  // ---------- Local save / restore ----------
  function saveState(){
    try{
      const payload = {
        v: 1,
        activeDistrictId,
        districts: districts.map(d => ({id: d.id, name: d.name})),
        assignments: [...assignments.entries()]
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    } catch(e) { /* ignore */ }
  }

  function restoreState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const payload = JSON.parse(raw);
      if(!payload || !Array.isArray(payload.districts) || !Array.isArray(payload.assignments)) return false;

      districts = payload.districts
        .map(d => ({id: +d.id, name: String(d.name || `District ${d.id}`)}))
        .filter(d => isFinite(d.id) && d.id > 0);

      assignments.clear();
      for(const pair of payload.assignments){
        if(!Array.isArray(pair) || pair.length < 2) continue;
        const key = String(pair[0]);
        const did = +pair[1];
        if(!key || !isFinite(did) || did <= 0) continue;
        if(!featuresByKey.has(key)) continue;
        assignments.set(key, did);
      }

      activeDistrictId = (+payload.activeDistrictId) || (districts.length ? districts[districts.length - 1].id : 0);
      undoStack.length = 0;
      redoStack.length = 0;
      refreshAllStyles();
      refreshUI();
      return true;
    } catch(e) {
      return false;
    }
  }

  // ---------- Paint mode ----------
  function setPaintMode(on){
    paintMode = !!on;
    mouseDown = false;
    const b = $("btnPaint");
    if(b) b.textContent = paintMode ? "Paint: On" : "Paint: Off";
    if(map){
      try{
        if(paintMode){
          map.dragging.disable();
          map.doubleClickZoom.disable();
        } else {
          map.dragging.enable();
          map.doubleClickZoom.enable();
        }
      } catch(e){}
    }
  }

  function paintAtKey(key, originalEvent){
    if(!paintMode || !mouseDown) return;
    if(!activeDistrictId) return;
    const shift = !!(originalEvent && originalEvent.shiftKey);
    setAssignment(key, shift ? 0 : activeDistrictId, true);
  }

// ---------- Wire UI ----------
  $("btnNewDistrict").addEventListener("click", addDistrict);
  $("btnDeleteDistrict").addEventListener("click", deleteActiveDistrict);
  $("btnUndo").addEventListener("click", undo);
  $("btnRedo").addEventListener("click", redo);
  $("btnPaint").addEventListener("click", () => setPaintMode(!paintMode));
  $("btnClear").addEventListener("click", clearPlan);
  $("btnExport").addEventListener("click", exportPlan);
  $("btnLoadSample").addEventListener("click", () => loadSample().catch(err => showToast("Sample load failed", err.message)));

  // Mouse up anywhere ends paint strokes
  window.addEventListener("mouseup", () => { mouseDown = false; });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && !e.altKey && e.key.toLowerCase() === "z"){
      e.preventDefault();
      if(e.shiftKey) redo(); else undo();
    }
    if(mod && !e.altKey && e.key.toLowerCase() === "y"){
      e.preventDefault();
      redo();
    }
  });

  $("fileVotes").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const text = await f.text();
      if(f.name.toLowerCase().endsWith(".csv")){
        importCSV(text);
      } else {
        const rows = JSON.parse(text);
        importRows(rows, {source:f.name});
      }
    } catch(err){
      showToast("Import failed", err.message || String(err));
    } finally {
      e.target.value = "";
    }
  });
  // Map load
  loadMap().then(() => { restoreState(); }).catch(err => {
    $("mapChip").textContent = "Map failed";
    showToast("Map load failed", err.message || String(err), 8000);
  });

  // Initial
  refreshUI();
})();
</script>
</body>
</html>
