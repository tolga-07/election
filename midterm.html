<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Election Forecast</title>

  <!-- D3 + TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <style>html{ color-scheme: light; }

    :root{
      --bg0:#f6f7fb;
      --bg1:#ffffff;
      --ink:#0b1220;
      --muted:#5b6477;
      --muted2:#7b859a;

      --card:#ffffffcc;
      --cardSolid:#ffffff;
      --line:rgba(16,24,40,.10);
      --line2:rgba(16,24,40,.08);

      --shadow: 0 18px 55px rgba(16,24,40,.10);
      --shadow2: 0 8px 24px rgba(16,24,40,.08);

      --blue:#2563eb;
      --red:#dc2626;
      --blueSoft: rgba(37,99,235,.16);
      --redSoft: rgba(220,38,38,.16);

      --focus: 0 0 0 4px rgba(99,102,241,.18);
      --radius: 18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --gridTint: rgba(16,24,40,.06);
      --gridTint2: rgba(16,24,40,.04);
      --zero:#0b1220;

      --ok: rgba(16,185,129,.95);
      --warn: rgba(245,158,11,.95);

      --chipBg: rgba(255,255,255,.75);
      --chipBorder: rgba(16,24,40,.10);
    }

    
/* dark mode disabled */


    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 700px at 18% -12%, rgba(99,102,241,.18), transparent 56%),
        radial-gradient(900px 700px at 108% 12%, rgba(244,63,94,.14), transparent 56%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 30%, var(--bg0));
      overflow-x:hidden;
    }

    .wrap{
      max-width:1220px;
      margin:0 auto;
      padding:18px 18px 34px;
    }

    .appbar{
      position:sticky;
      top:0;
      z-index:60;
      padding:12px 0 14px;
      backdrop-filter: blur(10px);
    }
    .appbarInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:22px;
      background: linear-gradient(180deg, var(--card), transparent);
      border:1px solid var(--line2);
      box-shadow: var(--shadow2);
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:250px;
    }
    .brandMark{
      width:36px;height:36px;
      border-radius:13px;
      background:
        radial-gradient(12px 12px at 35% 35%, rgba(255,255,255,.9), transparent 55%),
        linear-gradient(145deg, rgba(37,99,235,.95), rgba(99,102,241,.55));
      box-shadow: 0 10px 22px rgba(37,99,235,.25);
      border:1px solid rgba(255,255,255,.22);
    }
    .brandTitle{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .brandTitle .t{
      font-size:14px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .brandTitle .s{
      font-size:12px;
      color:var(--muted2);
      font-weight:700;
    }

    .seg{
      position:relative;
      display:flex;
      background: var(--cardSolid);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-width:260px;
      justify-content:space-between;
    }
    .seg button{
      position:relative;
      appearance:none;
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:950;
      font-size:13px;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      flex:1;
      text-align:center;
      transition: color .15s ease;
    }
    .seg button.active{ color: var(--ink); }
    .segIndicator{
      position:absolute;
      top:4px; bottom:4px;
      width:calc(33.333% - 4px);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(99,102,241,.22), rgba(99,102,241,.12));
      border:1px solid rgba(99,102,241,.18);
      box-shadow: 0 10px 22px rgba(99,102,241,.10);
      transform: translateX(0%);
      transition: transform .18s ease;
      pointer-events:none;
    }
    .seg[data-mode="governor"] .segIndicator{ transform: translateX(100%); }
    .seg[data-mode="house"] .segIndicator{ transform: translateX(200%); }

    .barActions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--chipBorder);
      background: var(--chipBg);
      box-shadow: var(--shadow2);
      white-space:nowrap;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      user-select:none;
    }
    .chip strong{
      color:var(--ink);
      font-weight:950;
      font-variant-numeric: tabular-nums;
    }
    .dot{ width:8px;height:8px;border-radius:999px; background: var(--muted2); }
    .dot.ok{ background: var(--ok); }
    .dot.blue{ background: var(--blue); }
    .dot.red{ background: var(--red); }

    .layout{
      display:block;
      gap:14px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ display:block; }
      .brand{ min-width:auto; }
      .seg{ min-width:220px; }
    }


    .mapStage{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
    }
    /* Projected seats overlay on map */
    .seatOverlay{
      position:absolute;
      top:12px;
      left:12px;
      width:340px;
      max-width: calc(100% - 24px);
      box-shadow: 0 18px 46px rgba(17,24,39,.20);
      z-index: 4;
    }
    /* On small screens, keep it above the map instead of covering it */
    @media (max-width: 640px){
      .seatOverlay{
        position: relative;
        top:auto;
        left:auto;
        width:auto;
        margin:12px;
      }
    }

    .card{
      border:1px solid var(--line2);
      border-radius:var(--radius);
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardTitleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.55), transparent);
    }
    /* dark mode disabled */

    .cardTitle{
      display:flex;
      flex-direction:column;
      gap:3px;
      line-height:1.15;
    }
    .cardTitle .h{
      font-size:13px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .cardTitle .sub{
      font-size:12px;
      color:var(--muted2);
      font-weight:750;
    }
    .cardInner{ padding:14px; }

    /* Projected seats card */
    .seatHeader{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line2);
    }
    .seatHeadLeft .h{ margin:0; }
    #seatNumbers{
      margin-top:6px;
      font-size:20px;
      font-weight:950;
      letter-spacing:-0.02em;
      color:var(--text);
      font-variant-numeric: tabular-nums;
    }

    .seatPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 26px rgba(16,24,40,.08);
      user-select:none;
      min-width: 170px;
    }
    .seatDot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(107,114,128,.75);
      box-shadow: 0 0 0 3px rgba(16,24,40,.06) inset;
      flex:0 0 auto;
    }
    .seatPill.blue .seatDot{ background: rgba(37,99,235,.92); }
    .seatPill.red  .seatDot{ background: rgba(220,38,38,.92); }
    .seatPill.neutral .seatDot{ background: rgba(107,114,128,.70); }

    .seatPillLabel{
      font-size:11px;
      font-weight:950;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted2);
      line-height:1.1;
    }
    .seatPillValue{
      margin-top:2px;
      font-size:13px;
      font-weight:950;
      color:var(--text);
      font-variant-numeric: tabular-nums;
      line-height:1.1;
      white-space:nowrap;
    }
    .seatPillTextWrap{ display:flex; flex-direction:column; }

    .seatLegendRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      font-weight:850;
    }

    @media (max-width: 640px){
      .seatPill{ min-width: 0; width:100%; justify-content:flex-start; }
    }

    .tiny{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      font-weight:750;
    }
    .mono{ font-family:var(--mono); font-size:12px; }

    /* Seat meter */
    .seatAxis{
      position:relative;
      height:64px;
      border-radius:16px;
      border:1px solid var(--line);
      background: var(--cardSolid);
      overflow:hidden;
    }
    #seatTicks{ position:absolute; inset:0; }
    .seatBar{
      position:absolute;
      left:14px; right:14px;
      top:22px;
      height:12px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:
        linear-gradient(180deg, rgba(16,24,40,.03), transparent),
        rgba(16,24,40,.02);
      overflow:hidden;
      display:flex;
    }
    /* dark mode disabled */

    .seatSeg{ height:100%; transition: width .18s ease; }
    .seatD{ background: linear-gradient(180deg, rgba(37,99,235,.90), rgba(37,99,235,.58)); }
    .seatR{ background: linear-gradient(180deg, rgba(220,38,38,.90), rgba(220,38,38,.58)); }
    .seatO{ background: rgba(107,114,128,.22); }
    .seatMajorityLine{
      position:absolute;
      top:0; bottom:0;
      width:2px;
      background: var(--zero);
      opacity:1;
    }
    .seatTickLabel{
      position:absolute;
      bottom:9px;
      transform:translateX(-50%);
      font-size:11px;
      font-weight:950;
      color: var(--muted2);
      user-select:none;
      font-variant-numeric: tabular-nums;
    }
    .seatTickLine{
      position:absolute;
      top:0; bottom:0;
      width:1px;
      background: var(--gridTint2);
    }
    .seatFooter{
      padding:12px 14px 14px;
      color:var(--muted);
      font-size:12px;
      font-weight:850;
      line-height:1.45;
    }


    .mapGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .mapGrid{ grid-template-columns: 1fr; }
    }

    /* Seat card is no longer an overlay for the map; it's a sibling panel */
    .seatOverlay{ position:static; top:auto; left:auto; width:auto; max-width:none; box-shadow:none; z-index:auto; }

    /* Map */
    #mapCard{ position:relative; }
    #map{
      width:100%;
      height:600px;
      overflow: visible;
      display:block;
      background:
        radial-gradient(900px 420px at 40% 40%, rgba(99,102,241,.06), transparent 58%),
        radial-gradient(900px 420px at 70% 60%, rgba(244,63,94,.05), transparent 58%),
        linear-gradient(180deg, rgba(16,24,40,.02), transparent);
    }
    /* dark mode disabled */

    .state{
      stroke: rgba(11,18,32,.28);
      stroke-width:1.1;
      vector-effect: non-scaling-stroke;
      cursor:default;
      transition: filter .08s ease, stroke-width .08s ease, stroke .08s ease;
    }
    /* dark mode disabled */

    .state.active{ cursor:pointer; }
    .state.hovered{
      stroke: rgba(11,18,32,.92);
      stroke-width:1.8;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.22));
    }
    /* dark mode disabled */

    
    .district{
      stroke: rgba(11,18,32,.22);
      stroke-width:0.7;
      vector-effect: non-scaling-stroke;
      cursor:default;
      transition: filter .08s ease, stroke-width .08s ease, stroke .08s ease;
    }
    .district.active{ cursor:pointer; }
    .district.hovered{
      stroke: rgba(11,18,32,.92);
      stroke-width:1.6;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.18));
    }
.legendOverlay{
      position:absolute;
      left:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: var(--card);
      backdrop-filter: blur(10px);
      border:1px solid var(--line2);
      box-shadow: var(--shadow2);
      max-width:360px;
    }
    .swatch{
      width:170px;
      height:12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: linear-gradient(90deg,
        rgba(37,99,235,.88) 0%,
        rgba(37,99,235,.18) 35%,
        rgba(255,255,255,.85) 50%,
        rgba(220,38,38,.18) 65%,
        rgba(220,38,38,.88) 100%);
    }
    /* dark mode disabled */


    /* Tooltip sliders */
    #tip{
      position:fixed;
      left:0; top:0;
      transform: translate(-9999px,-9999px);
      pointer-events:none;
      width:430px;
      z-index:90;
      border-radius:18px;
      background: var(--card);
      backdrop-filter: blur(14px);
      border:1px solid var(--line2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tipTop{
      padding:12px 14px;
      border-bottom:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(99,102,241,.10), transparent);
    }
    /* dark mode disabled */

    .tipHeader{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .tipTitle{ margin:0; font-size:14px; font-weight:950; letter-spacing:.2px; line-height:1.1; }
    .tipMeta{
      text-align:right;
      font-size:12px;
      color:var(--muted2);
      font-weight:950;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .tipSub{
      margin-top:6px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--cardSolid);
      box-shadow: var(--shadow2);
      font-variant-numeric: tabular-nums;
    }
    .tipBody{ padding:12px 14px 14px; }

    .sliderBlock{ margin-top:12px; }
    .sliderLabelRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:7px;
    }
    .sliderLabel{
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:7px;
    }
    .chev{ width:12px;height:12px; opacity:.7; }
    .sliderValue{
      font-size:12px;
      font-weight:950;
      color:var(--muted2);
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .axis{
      position:relative;
      height:52px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(16,24,40,.02), transparent),
        var(--cardSolid);
    }
    /* dark mode disabled */

    .gridline{ position:absolute; top:0; bottom:0; width:1px; background: var(--gridTint); }
    .zeroLine{ background: var(--zero) !important; width:2px !important; opacity:1 !important; }
    .tickLabel{
      position:absolute;
      bottom:7px;
      transform:translateX(-50%);
      font-size:11px;
      font-weight:950;
      opacity:.95;
      user-select:none;
      font-variant-numeric: tabular-nums;
    }
    .tickBlue{ color: rgba(37,99,235,.95); }
    .tickRed{  color: rgba(220,38,38,.95); }
    .tickZero{ color: var(--zero); }

    .band{
      position:absolute;
      top:14px;
      height:12px;
      border-radius:999px;
      filter:saturate(1.06);
    }
    .marker{
      position:absolute;
      top:9px;
      width:18px; height:18px;
      border-radius:999px;
      transform:translateX(-50%);
      border:3px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    /* dark mode disabled */

    .hr{ height:1px; background: var(--line2); margin:12px 0; }

    /* Error overlay */
    .errorBox{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(220,38,38,.22);
      background: rgba(220,38,38,.08);
      color: var(--ink);
      font-weight:900;
      line-height:1.4;
    }
  

    .loadError{
      margin: 10px 0 2px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(220,38,38,.22);
      background: rgba(220,38,38,.08);
      box-shadow: var(--shadow2);
      font-weight: 850;
      line-height: 1.4;
    }
    .loadError .mono{ font-family: var(--mono); }

    /* ---------- User-facing cleanup ---------- */
    .barActions, #statusCard, #howCard{ display:none !important; }
    #mapCard .cardTitleRow .chip{ display:none !important; }
    .legendOverlay .tiny{ display:none !important; }

    /* Make win probability hard to miss */
    .tipSub{ gap:8px; }
    #tipProbBadge{
      flex: 1 1 auto;
      justify-content:center;
      padding:10px 12px;
      border-radius:14px;
    }
    #tipProb{
      font-size:16px;
      font-weight:950;
      color:var(--ink);
    }
    #tipResultBadge{ opacity:.75; }

  
    /* Bucket table */
    #raceTableCard .sub{ opacity:.72; }
    .tableScroll{ overflow:auto; border-radius:16px; }
    .bucketTable{
      width:100%;
      border-collapse:separate;
      border-spacing:10px 10px;
      min-width:980px;
    }
    .bucketTable th{
      text-align:left;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:rgba(16,24,40,.78);
      padding:8px 10px;
      background:rgba(16,24,40,.05);
      border:1px solid rgba(16,24,40,.08);
      border-radius:14px;
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter:saturate(140%) blur(8px);
    }
    .bucketTable td{ vertical-align:top; padding:0; }
    .raceItem{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:2px;
      border-radius:14px;
      padding:10px 10px;
      border:1px solid rgba(16,24,40,.12);
      background:rgba(255,255,255,.72);
      text-align:left;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(16,24,40,.02);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .raceItem:hover{
      transform:translateY(-1px);
      border-color:rgba(16,24,40,.26);
      box-shadow:0 10px 26px rgba(16,24,40,.10);
    }
    .raceItem .st{ font-weight:800; letter-spacing:.06em; }
    .raceItem .meta{ font-size:12px; opacity:.78; }
    .raceItem.d{ border-left:5px solid rgba(24,119,255,.75); }
    .raceItem.r{ border-left:5px solid rgba(255,72,86,.75); }
    .raceItem.t{ border-left:5px solid rgba(16,24,40,.30); }
    .raceEmpty{
      height:44px;
      border-radius:14px;
      border:1px dashed rgba(16,24,40,.18);
      background:rgba(16,24,40,.02);
    }

  
    .state.focus{ stroke: rgba(16,24,40,.65); stroke-width:2.25; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="appbar">
      <div class="appbarInner">
        <div class="brand">
          <div class="brandMark" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="t">Midterm Forecast</div>
            <div class="s">Hover a state for details</div>
          </div>
        </div>

        <div class="seg" id="segMode" data-mode="senate" role="tablist" aria-label="Mode">
          <div class="segIndicator" aria-hidden="true"></div>
          <button id="btn-senate" class="active" role="tab" aria-selected="true">Senate</button>
          <button id="btn-governor" role="tab" aria-selected="false">Governor</button>
          <button id="btn-house" role="tab" aria-selected="false">House</button>
        </div>

      </div>
    </div>

    <div id="loadError" class="loadError" hidden></div>

    <div class="layout">
      <main style="display:flex;flex-direction:column;gap:14px;">
        <section class="card seatCard" id="seatCard">
          <div class="seatHeader">
            <div class="seatHeadLeft">
              <div class="h" id="seatTitle">Projected seats</div>
              <div class="seatNumbers" id="seatNumbers">—</div>
            </div>

            <div class="seatPill neutral" id="seatPill" aria-label="Majority odds">
              <span class="seatDot" aria-hidden="true"></span>
              <div class="seatPillTextWrap">
                <div class="seatPillLabel" id="seatPillLabel">Majority odds</div>
                <div class="seatPillValue" id="seatPillText">—</div>
              </div>
            </div>
          </div>

          <div class="cardInner">
            <div class="seatAxis" aria-label="Seat projection meter">
              <div id="seatTicks"></div>
              <div class="seatBar" aria-hidden="true">
                <div class="seatSeg seatD" id="seatSegD"></div>
                <div class="seatSeg seatO" id="seatSegO"></div>
                <div class="seatSeg seatR" id="seatSegR"></div>
              </div>
              <div class="seatMajorityLine" id="seatMajorityLine" aria-hidden="true"></div>
            </div>

            <div class="seatLegendRow" id="seatLegend" aria-hidden="true"></div>
          </div>

          <div class="seatFooter" id="seatFooterText">—</div>
        </section>

        <section class="card" id="mapCard">
          <div class="cardTitleRow">
            <div class="cardTitle">
              <div class="h">Map</div>
              <div class="sub" id="mapHelpText">Hover a state for details.</div>
            </div>
          </div>

          <div class="mapGrid">
  <div class="mapStage">
<svg id="map" aria-label="US map"></svg>

          <div class="legendOverlay" aria-hidden="true">
            <div class="swatch"></div>
          </div>
  </div>

  
</div>
        </section>

        <section class="card" id="raceTableCard">
          <div class="cardTitleRow">
            <div class="cardTitle">
              <div class="h">Races</div>
              <div class="sub">All races</div>
            </div>
          </div>

          <div class="cardInner">
            <div class="tableScroll" aria-label="Race table">
              <table class="bucketTable" id="bucketTable">
                <thead>
                  <tr>
                    <th>Likely D</th>
                    <th>Lean D</th>
                    <th>Tossup</th>
                    <th>Lean R</th>
                    <th>Likely R</th>
                  </tr>
                </thead>
                <tbody id="bucketBody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>
 </div> 

  <div id="tip" role="dialog" aria-label="State details tooltip">
    <div class="tipTop">
      <div class="tipHeader">
        <div>
          <p class="tipTitle" id="tipState">State</p>
          <div class="tipSub">
            <span class="badge" id="tipResultBadge"><span class="dot"></span><span id="tipWinner">—</span></span>
            <span class="badge" id="tipProbBadge"><span class="dot"></span><span id="tipProb">—</span></span>
          </div>
        </div>
        <div class="tipMeta" id="tipMeta">—</div>
      </div>
    </div>
    <div class="tipBody" id="tipSliders"></div>
  </div>

<script>
/* ---------- Config ---------- */
const PROB_ERROR_SD_PTS = 10; // hidden, used for win probabilities (state + senate majority)
const WEIGHTS = { gb:35, polls:50, ind:15 };
const VIS = { show:12.5, likely:7.5, lean:2.5 }; // UI buckets + map filter

function bucketKeyFromMargin(m){
  if (!isFinite(m)) return null;
  const a = Math.abs(m);
  const side = (m < 0) ? "D" : "R";

  // Safe: |margin| >= 12.5 — excluded from the table (still shown on the map)
  if (a >= VIS.show) return null;

  // Tossup: |margin| <= 2.5
  if (a <= VIS.lean) return "Tossup";

  // Lean: 2.5 < |margin| <= 7.5
  if (a <= VIS.likely) return `Lean ${side}`;

  // Likely: 7.5 < |margin| < 12.5
  return `Likely ${side}`;
}
function formatMarginDR(m){
  if (!isFinite(m)) return "—";
  const a = Math.abs(m);
  if (a < 0.05) return "Tied";
  return (m < 0) ? `D+${a.toFixed(1)}` : `R+${a.toFixed(1)}`;
}
function pseudoEvtFromEl(el){
  const r = el.getBoundingClientRect();
  return { clientX: r.left + r.width/2, clientY: r.top + r.height/2 };
}


const SEAT_RULES = {
  senate:   { total:100, majorityLine:51,  baseR:31, baseD:34 },
  governor: { total:50,  majorityLine:26,  baseR:8,  baseD:6  },
  house:    { total:435, majorityLine:218, baseR:0,  baseD:0  },
};
const SENATE_CONTROL_RULE = { demAtLeast: 51, repAtLeast: 50 };

/* ---------- FIPS lookup for US-atlas ---------- */
const FIPS_TO_USPS = {
  1:"AL",2:"AK",4:"AZ",5:"AR",6:"CA",8:"CO",9:"CT",10:"DE",11:"DC",12:"FL",13:"GA",15:"HI",16:"ID",17:"IL",18:"IN",19:"IA",20:"KS",21:"KY",22:"LA",23:"ME",24:"MD",25:"MA",26:"MI",27:"MN",28:"MS",29:"MO",30:"MT",31:"NE",32:"NV",33:"NH",34:"NJ",35:"NM",36:"NY",37:"NC",38:"ND",39:"OH",40:"OK",41:"OR",42:"PA",44:"RI",45:"SC",46:"SD",47:"TN",48:"TX",49:"UT",50:"VT",51:"VA",53:"WA",54:"WV",55:"WI",56:"WY"
};
const USPS_TO_NAME = {
  AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District of Columbia",
  FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",
  MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",
  NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",
  SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"
};
function fipsToUsps(id){ const n = parseInt(id, 10); return FIPS_TO_USPS[n] || ""; }
/* ---------- House district helpers ---------- */
const NAME_TO_USPS = Object.fromEntries(
  Object.entries(USPS_TO_NAME).map(([usps, name]) => [String(name).trim().toLowerCase(), usps])
);

function houseDistrictCode(usps, cd){
  if (!usps) return "";
  if (cd === 0) return `${usps}-AL`;
  return `${usps}-${String(cd).padStart(2,"0")}`;
}
function houseDistrictName(stateName, cd){
  if (!stateName) return "House district";
  return (cd === 0) ? `${stateName} At-Large` : `${stateName} District ${cd}`;
}


/* ---------- Math helpers ---------- */
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
function normalizePair(D, R){
  const d = Number(D), r = Number(R);
  const s = d + r;
  if (!isFinite(s) || s <= 0) return {D:50, R:50};
  return {D: 100*d/s, R: 100*r/s};
}
function marginRD(pair){ return pair.R - pair.D; } // negative = Dem lead
function fmtLead(m){
  if (!isFinite(m)) return "—";
  if (Math.abs(m) < 0.05) return "Tied";
  const pts = Math.abs(m).toFixed(1);
  return (m < 0) ? `D+${pts}` : `R+${pts}`;
}
function erf(x){
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t = 1/(1+p*x);
  const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
  return sign*y;
}
function normalCDF(x){ return 0.5*(1 + erf(x/Math.SQRT2)); }
function winProbFromMargin(m){
  const z = m / PROB_ERROR_SD_PTS;
  const pR = clamp(normalCDF(z), 0, 1);
  return { pD: 1 - pR, pR };
}

/* ---------- Color ---------- */
function interpColor(m){
  const max = 25;
  const t = clamp(Math.abs(m)/max, 0, 1);
  if (Math.abs(m) < 0.10) return "rgba(255,255,255,.86)";
  if (m < 0){
    const r = Math.round(248*(1-t) + 37*t);
    const g = Math.round(250*(1-t) + 99*t);
    const b = Math.round(252*(1-t) + 235*t);
    return `rgb(${r},${g},${b})`;
  } else {
    const r = Math.round(252*(1-t) + 220*t);
    const g = Math.round(250*(1-t) + 38*t);
    const b = Math.round(250*(1-t) + 38*t);
    return `rgb(${r},${g},${b})`;
  }
}

/* ---------- Data model loaded from CSV ---------- */
const DATA = {
  senate:   { gb:null, ratios:{}, polls:{} },
  governor: { gb:null, ratios:{}, polls:{} },
  house:    { gb:null, ratios:{}, polls:{}, meta:{} }, // meta: {code,name,state,cd}
};
function toNum(v){
  if (v === null || v === undefined) return NaN;
  const s = String(v).trim();
  if (!s) return NaN;
  const n = Number(s);
  return isFinite(n) ? n : NaN;
}


async function loadCSV(){
  const errBox = document.getElementById("loadError");
  try{
    const csvText = await fetch("entries_all.csv", {cache:"no-store"}).then(r=>{
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    });

    const rows = d3.csvParse(csvText);
    if (!rows || rows.length === 0) throw new Error("CSV empty");

    for (const row of rows){
      const mode = String(row.mode || "").trim().toLowerCase();
      if (!DATA[mode]) continue;

      const st = String(row.state || "").trim().toUpperCase();
      const ratioD = toNum(row.ratioD);
      const ratioR = toNum(row.ratioR);

      if (st && isFinite(ratioD) && isFinite(ratioR)){
        DATA[mode].ratios[st] = {D: ratioD, R: ratioR};
      }

      const gbD = toNum(row.gbD);
      const gbR = toNum(row.gbR);
      if (!DATA[mode].gb && isFinite(gbD) && isFinite(gbR)){
        DATA[mode].gb = normalizePair(gbD, gbR);
      }

      const pollD = toNum(row.pollD);
      const pollR = toNum(row.pollR);
      const pollS = toNum(row.pollSigma);
      if (isFinite(pollD) && isFinite(pollR)){
        DATA[mode].polls[st] = {
          D: pollD,
          R: pollR,
          S: isFinite(pollS) ? pollS : 3
        };
      }
    }

    // Fill missing GBs if only one mode had it
    if (!DATA.senate.gb && DATA.governor.gb) DATA.senate.gb = DATA.governor.gb;
    if (!DATA.governor.gb && DATA.senate.gb) DATA.governor.gb = DATA.senate.gb;

    if (errBox) errBox.hidden = true;
    return true;
  }catch(err){
    if (errBox){
      errBox.hidden = false;
      errBox.innerHTML = `
        Could not load <span class="mono">entries_all.csv</span> (must be in the same folder as this HTML).<br/>
        Error: <span class="mono">${String(err.message || err)}</span><br/>
        If you opened this as <span class="mono">file://</span>, serve it locally (e.g. <span class="mono">python3 -m http.server 8000</span>).
      `;
    }
    return false;
  }
}



async function loadHouseRatios(){
  const errBox = document.getElementById("loadError");
  try{
    const csvText = await fetch("house_district_ratios_filled.csv", {cache:"no-store"}).then(r=>{
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    });

    const rows = d3.csvParse(csvText);
    if (!rows || rows.length === 0) throw new Error("House ratios CSV empty");

    for (const row of rows){
      const rawId = String(row.path_id ?? "").trim();
      if (!rawId) continue;
      const did = rawId.padStart(4,"0");
      const dRatio = toNum(row.d_ratio);
      const rRatio = toNum(row.r_ratio);

      if (isFinite(dRatio) && isFinite(rRatio)){
        DATA.house.ratios[did] = { D: dRatio, R: rRatio };
      }

      const stateName = String(row.state_name ?? "").trim();
      const cd = parseInt(String(row.congressional_district_number ?? "").trim(), 10);
      const usps = NAME_TO_USPS[String(stateName).toLowerCase()] || "";
      const code = houseDistrictCode(usps, isFinite(cd) ? cd : 0) || did;
      const name = houseDistrictName(stateName || (USPS_TO_NAME[usps] || usps), isFinite(cd) ? cd : 0);

      DATA.house.meta[did] = { code, name, state: stateName, cd: (isFinite(cd) ? cd : 0), usps };
    }

    // House generic ballot comes from the Senate CSV
    if (!DATA.house.gb){
      DATA.house.gb = DATA.senate.gb || DATA.governor.gb || {D:50,R:50};
    }

    if (errBox) errBox.hidden = true;
    return true;
  }catch(err){
    if (errBox){
      errBox.hidden = false;
      errBox.innerHTML = `
        Could not load <span class="mono">house_district_ratios_filled.csv</span> (must be in the same folder as this HTML).<br/>
        Error: <span class="mono">${String(err.message || err)}</span><br/>
        If you opened this as <span class="mono">file://</span>, serve it locally (e.g. <span class="mono">python3 -m http.server 8000</span>).
      `;
    }
    return false;
  }
}

/* ---------- Model computation ---------- */
function computeGenericBallotState(gb, ratio){
  return normalizePair(gb.D * ratio.D, gb.R * ratio.R);
}
function computePollState(poll){
  if (!poll) return null;
  const D = Number(poll.D), R = Number(poll.R);
  if (!isFinite(D) || !isFinite(R) || (D+R)<=0) return null;
  return normalizePair(D, R);
}
function computeIndicatorNationalFromPolls(modeKey){
  const ratios = DATA[modeKey].ratios;
  const polls = DATA[modeKey].polls;

  const implied = [];
  for (const st of Object.keys(ratios)){
    const p = computePollState(polls[st]);
    if (!p) continue;
    const r = ratios[st];
    implied.push({ D: p.D / r.D, R: p.R / r.R });
  }
  if (implied.length === 0) return null;

  const avg = implied.reduce((a,x)=>({D:a.D+x.D, R:a.R+x.R}), {D:0,R:0});
  avg.D /= implied.length; avg.R /= implied.length;
  return normalizePair(avg.D, avg.R);
}
function computeIndicatorState(indNat, ratio){
  return normalizePair(indNat.D * ratio.D, indNat.R * ratio.R);
}
function weightedCombine(components){
  let W=0, D=0, R=0, sig2=0;
  for (const c of components){
    if (!c || !c.pair || !isFinite(c.w) || c.w<=0) continue;
    W += c.w;
    D += c.w * c.pair.D;
    R += c.w * c.pair.R;
    sig2 += c.w * (c.sigma*c.sigma);
  }
  if (W<=0) return {pair:{D:50,R:50}, sigma:6};
  return { pair: normalizePair(D/W, R/W), sigma: Math.sqrt(sig2/W) };
}

function getStateModel(modeKey, st, cachedIndNat){
  const gb = DATA[modeKey].gb || {D:50,R:50};
  const ratios = DATA[modeKey].ratios;
  const ratio = ratios[st];
  if (!ratio) return null;

  const gbPair = computeGenericBallotState(gb, ratio);

  const pollRaw = DATA[modeKey].polls[st];
  const pollPair = computePollState(pollRaw);
  const pollSigma = pollRaw && isFinite(Number(pollRaw.S)) ? Number(pollRaw.S) : 3;

  const indNat = cachedIndNat; // computed once per mode
  const indPair = (indNat) ? computeIndicatorState(indNat, ratio) : null;

  const comps = [
    { pair: gbPair,   w: WEIGHTS.gb,              sigma: 6 },
    { pair: pollPair, w: pollPair ? WEIGHTS.polls : 0, sigma: pollSigma },
    { pair: indPair,  w: indPair ? WEIGHTS.ind : 0,     sigma: 5 },
  ];
  const combined = weightedCombine(comps);

  const mFinal = marginRD(combined.pair);
  const winProb = winProbFromMargin(mFinal);

  return { gbPair, pollPair, indPair, combinedPair: combined.pair, combinedSigma: combined.sigma, winProb };
}


function getHouseModel(did){
  const gb = DATA.house.gb || DATA.senate.gb || DATA.governor.gb || {D:50,R:50};
  const ratio = DATA.house.ratios[did];
  if (!ratio) return null;

  const gbPair = computeGenericBallotState(gb, ratio);
  const combinedPair = gbPair;
  const combinedSigma = 6;

  const mFinal = marginRD(combinedPair);
  const winProb = winProbFromMargin(mFinal);

  return { gbPair, combinedPair, combinedSigma, winProb };
}

/* ---------- Majority probability (exact Poisson-binomial) ---------- */
function chamberMajorityProbExact(modeKey, cachedIndNat){
  const rules = SEAT_RULES[modeKey];
  const ratios = DATA[modeKey].ratios;

  const upSeats = rules.total - rules.baseD - rules.baseR;
  const keys = Object.keys(ratios);
  const modeled = keys.length;
  const missing = Math.max(0, upSeats - modeled);

  const pDem = [];
  for (const key of keys){
    const m = (modeKey === "house")
      ? getHouseModel(key)
      : getStateModel(modeKey, key, cachedIndNat);
    pDem.push(m ? m.winProb.pD : 0.5);
  }
  for (let i=0;i<missing;i++) pDem.push(0.5);

  let dist = new Array(pDem.length+1).fill(0);
  dist[0] = 1;
  for (let i=0;i<pDem.length;i++){
    const p = clamp(pDem[i], 0, 1);
    const nxt = new Array(pDem.length+1).fill(0);
    for (let k=0;k<=i;k++){
      nxt[k]   += dist[k] * (1-p);
      nxt[k+1] += dist[k] * p;
    }
    dist = nxt;
  }

  const needWinsForDemMajority = Math.max(0, rules.majorityLine - rules.baseD);
  let pDemMaj = 0;
  for (let k=needWinsForDemMajority; k<dist.length; k++) pDemMaj += dist[k];

  const pRepMaj = clamp(1 - pDemMaj, 0, 1);
  return { pDemMaj, pRepMaj, upSeats, modeled, missing };
}
function senateMajorityProbExact(cachedIndNat){ return chamberMajorityProbExact("senate", cachedIndNat); }
function houseMajorityProbExact(){ return chamberMajorityProbExact("house", null); }


/* ---------- UI: sliders ---------- */
function chevronSVG(){
  return `
    <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8 10l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M8 14l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;
}


function sliderHTML(title, m, sigma){
  const min=-25, max=25;
  const mm = clamp(m, min, max);
  const left = clamp(mm - sigma, min, max);
  const right= clamp(mm + sigma, min, max);
  const toPct = v => ((v-min)/(max-min))*100;

  const markerLeft = toPct(mm);
  const bandLeft = toPct(left);
  const bandWidth = Math.max(0, toPct(right) - toPct(left));

  const crosses0 = (left < 0 && right > 0);
  let bandBg = "";
  if (crosses0){
    const pivot = ((0-left)/(right-left))*100;
    bandBg = `linear-gradient(to right, var(--blueSoft) 0%, var(--blueSoft) ${pivot}%, var(--redSoft) ${pivot}%, var(--redSoft) 100%)`;
  } else if (right <= 0) bandBg = `var(--blueSoft)`;
  else bandBg = `var(--redSoft)`;

  const markerBg = (mm < 0) ? "var(--blue)" : (mm > 0 ? "var(--red)" : "var(--zero)");

  const ticks = [-25,-15,-5,0,5,15,25].map(t=>{
    const p = toPct(t);
    const cls = (t===0) ? "tickLabel tickZero" : (t<0 ? "tickLabel tickBlue" : "tickLabel tickRed");
    const glCls = (t===0) ? "gridline zeroLine" : "gridline";
    return `
      <div class="${glCls}" style="left:${p}%"></div>
      <div class="${cls}" style="left:${p}%">${t}</div>
    `;
  }).join("");

  return `
    <div class="sliderBlock">
      <div class="sliderLabelRow">
        <div class="sliderLabel">${title} ${chevronSVG()}</div>
        <div class="sliderValue">${fmtLead(mm)}</div>
      </div>
      <div class="axis">
        ${ticks}
        <div class="band" style="left:${bandLeft}%; width:${bandWidth}%; background:${bandBg};"></div>
        <div class="marker" style="left:${markerLeft}%; background:${markerBg};"></div>
      </div>
    </div>
  `;
}

function sliderEmptyHTML(title, note="No data"){
  const min=-25, max=25;
  const toPct = v => ((v-min)/(max-min))*100;
  const ticks = [-25,-15,-5,0,5,15,25].map(t=>{
    const p = toPct(t);
    const cls = (t===0) ? "tickLabel tickZero" : (t<0 ? "tickLabel tickBlue" : "tickLabel tickRed");
    const glCls = (t===0) ? "gridline zeroLine" : "gridline";
    return `
      <div class="${glCls}" style="left:${p}%"></div>
      <div class="${cls}" style="left:${p}%">${t}</div>
    `;
  }).join("");
  return `
    <div class="sliderBlock">
      <div class="sliderLabelRow">
        <div class="sliderLabel">${title} ${chevronSVG()}</div>
        <div class="sliderValue">${note}</div>
      </div>
      <div class="axis">${ticks}</div>
    </div>
  `;
}


function buildDetailHTML(modeKey, key, cachedIndNat){
  if (modeKey === "house"){
    const model = getHouseModel(key);
    if (!model) return { header:null, body:`<div class="tiny">No model for this district.</div>` };

    const mFinal = marginRD(model.combinedPair);
    const gbM = marginRD(model.gbPair);

    const pD = Math.round(model.winProb.pD*100);
    const pR = Math.round(model.winProb.pR*100);

    const body = `
      ${sliderHTML("Generic ballot", gbM, 6)}
      <div class="hr"></div>
      ${sliderHTML("Final", mFinal, model.combinedSigma)}
    `;

    return {
      header: {
        resultText: `Result: ${fmtLead(mFinal)}`,
        probText: `Win prob: D ${pD}% · R ${pR}%`,
        metaText: `D ${model.combinedPair.D.toFixed(1)} · R ${model.combinedPair.R.toFixed(1)}`,
        mFinal
      },
      body
    };
  }

  const model = getStateModel(modeKey, key, cachedIndNat);
  if (!model) return { header:null, body:`<div class="tiny">No model for this state.</div>` };

  const mFinal = marginRD(model.combinedPair);
  const gbM = marginRD(model.gbPair);
  const pollM = model.pollPair ? marginRD(model.pollPair) : NaN;
  const indM  = model.indPair  ? marginRD(model.indPair)  : NaN;

  const pollRaw = DATA[modeKey].polls[key];
  const pollSigma = pollRaw && isFinite(Number(pollRaw.S)) ? Number(pollRaw.S) : 3;

  const pD = Math.round(model.winProb.pD*100);
  const pR = Math.round(model.winProb.pR*100);

  const body = `
    ${sliderHTML("Generic ballot", gbM, 6)}
    ${model.pollPair ? sliderHTML("Polls", pollM, pollSigma) : sliderEmptyHTML("Polls", "No poll for this state")}
    ${cachedIndNat ? sliderHTML("National trend", indM, 5) : sliderEmptyHTML("National trend", "No polls entered anywhere")}
    <div class="hr"></div>
    ${sliderHTML("Final", mFinal, model.combinedSigma)}
  `;

  return {
    header: {
      resultText: `Result: ${fmtLead(mFinal)}`,
      probText: `Win prob: D ${pD}% · R ${pR}%`,
      metaText: `D ${model.combinedPair.D.toFixed(1)} · R ${model.combinedPair.R.toFixed(1)}`,
      mFinal
    },
    body
  };
}


/* ---------- Tooltip ---------- */
const tip = document.getElementById("tip");
const tipState = document.getElementById("tipState");
const tipWinner = document.getElementById("tipWinner");
const tipProb = document.getElementById("tipProb");
const tipMeta = document.getElementById("tipMeta");
const tipSliders = document.getElementById("tipSliders");
const tipResultBadge = document.getElementById("tipResultBadge");
const tipProbBadge = document.getElementById("tipProbBadge");


function showTooltip(evt, modeKey, key, cachedIndNat){
  const detail = buildDetailHTML(modeKey, key, cachedIndNat);
  if (!detail.header) return;

  const { resultText, probText, metaText, mFinal } = detail.header;

  if (modeKey === "house"){
    const meta = DATA.house.meta[key] || {};
    const code = meta.code || key;
    tipState.textContent = code;
    tipMeta.textContent = (meta.name ? `${meta.name} · ${metaText}` : metaText);
  } else {
    const name = USPS_TO_NAME[key] || key;
    tipState.textContent = `${name} (${key})`;
    tipMeta.textContent = metaText;
  }

  const resDot = tipResultBadge.querySelector(".dot");
  resDot.classList.toggle("blue", mFinal < 0);
  resDot.classList.toggle("red",  mFinal > 0);

  tipWinner.textContent = resultText;
  tipProb.textContent = probText;

  const probDot = tipProbBadge.querySelector(".dot");
  const pd = parseInt(probText.match(/D\s(\d+)%/)?.[1] || "50", 10);
  const pr = parseInt(probText.match(/R\s(\d+)%/)?.[1] || "50", 10);
  if (pd > pr){ probDot.classList.add("blue"); probDot.classList.remove("red"); }
  else if (pr > pd){ probDot.classList.add("red"); probDot.classList.remove("blue"); }
  else { probDot.classList.remove("blue"); probDot.classList.remove("red"); }

  tipSliders.innerHTML = detail.body;

  tip.style.transform = "translate(0,0)";
  positionTooltip(evt);
}

function positionTooltip(evt){
  const pad = 14;
  const w = tip.offsetWidth;
  const h = tip.offsetHeight;

  let x = evt.clientX + pad;
  let y = evt.clientY + pad;

  if (x + w + pad > window.innerWidth) x = evt.clientX - w - pad;
  if (y + h + pad > window.innerHeight) y = evt.clientY - h - pad;

  tip.style.left = x + "px";
  tip.style.top  = y + "px";
}
function hideTooltip(){ tip.style.transform = "translate(-9999px,-9999px)"; }

/* ---------- Seat meter ---------- */
const seatTitle = document.getElementById("seatTitle");
const seatNumbers = document.getElementById("seatNumbers");
const seatFooterText = document.getElementById("seatFooterText");
const seatPill = document.getElementById("seatPill");
const seatPillLabel = document.getElementById("seatPillLabel");
const seatPillText = document.getElementById("seatPillText");
const seatLegend = document.getElementById("seatLegend");
const seatTicks = document.getElementById("seatTicks");
const seatSegD = document.getElementById("seatSegD");
const seatSegR = document.getElementById("seatSegR");
const seatSegO = document.getElementById("seatSegO");
const seatMajorityLine = document.getElementById("seatMajorityLine");


function renderSeatTicks(total, majorityLine){
  let ticks = [];
  if (total >= 400){
    ticks = [0,100,200,300,400,total];
  } else if (total >= 100){
    ticks = [0,25,50,75,100];
    if (total !== 100) ticks[ticks.length-1] = total;
  } else if (total === 50){
    ticks = [0,10,20,30,40,50];
  } else {
    const step = Math.max(1, Math.round(total/5));
    ticks = [0, step, step*2, step*3, total];
  }

  // De-dup + sort
  ticks = Array.from(new Set(ticks)).sort((a,b)=>a-b);

  seatTicks.innerHTML = ticks.map(t=>{
    const p = (t/total)*100;
    return `
      <div class="seatTickLine" style="left:${p}%"></div>
      <div class="seatTickLabel" style="left:${p}%">${t}</div>
    `;
  }).join("");
  seatMajorityLine.style.left = `${(majorityLine/total)*100}%`;
}



function computeSeatTally(modeKey, cachedIndNat){
  const rules = SEAT_RULES[modeKey];
  const ratios = DATA[modeKey].ratios;

  let up = 0, winsD = 0, winsR = 0, toss = 0;

  for (const key of Object.keys(ratios)){
    const model = (modeKey === "house")
      ? getHouseModel(key)
      : getStateModel(modeKey, key, cachedIndNat);
    if (!model) continue;

    up += 1;

    const m = marginRD((modeKey === "house") ? model.combinedPair : model.combinedPair);
    if (!isFinite(m)) continue;

    if (Math.abs(m) < 0.05){ winsD += 0.5; winsR += 0.5; toss += 1; }
    else if (m < 0) winsD += 1;
    else winsR += 1;
  }

  const totalD = rules.baseD + winsD;
  const totalR = rules.baseR + winsR;
  let other = rules.total - totalD - totalR;
  if (other < 0 && other > -0.001) other = 0;

  return { ...rules, up, winsD, winsR, toss, totalD, totalR, other };
}



function updateSeatMeter(){
  const rules = SEAT_RULES[MODE];
  renderSeatTicks(rules.total, rules.majorityLine);

  const tally = computeSeatTally(MODE, IND_CACHE[MODE]);

  seatSegD.style.width = `${(tally.totalD / rules.total) * 100}%`;
  seatSegR.style.width = `${(tally.totalR / rules.total) * 100}%`;
  seatSegO.style.width = `${(Math.max(0, rules.total - tally.totalD - tally.totalR) / rules.total) * 100}%`;

  seatNumbers.textContent = `D ${tally.totalD.toFixed(1)} · R ${tally.totalR.toFixed(1)}`;

  const leader = (tally.totalD > tally.totalR) ? "D" : (tally.totalR > tally.totalD ? "R" : "T");
  seatPill.classList.toggle("blue", leader==="D");
  seatPill.classList.toggle("red",  leader==="R");
  seatPill.classList.toggle("neutral", leader==="T");

  if (MODE === "senate"){
    seatTitle.textContent = "Projected Senate seats";
    const maj = senateMajorityProbExact(IND_CACHE.senate);
    seatPillLabel.textContent = "Majority odds";
    seatPillText.textContent = `Dem ${Math.round(maj.pDemMaj*100)}%`;
    seatFooterText.innerHTML = `
      <span class="mono">D ${tally.totalD.toFixed(1)}</span> · <span class="mono">R ${tally.totalR.toFixed(1)}</span> · Majority line <span class="mono">${rules.majorityLine}</span><br/>
      Modeled states: <span class="mono">${maj.modeled}</span> of <span class="mono">${maj.upSeats}</span> up (${maj.missing} missing assumed 50/50)
    `;
  } else if (MODE === "house"){
    seatTitle.textContent = "Projected House seats";
    const maj = houseMajorityProbExact();
    seatPillLabel.textContent = "Majority odds";
    seatPillText.textContent = `Dem ${Math.round(maj.pDemMaj*100)}%`;
    seatFooterText.innerHTML = `
      <span class="mono">D ${tally.totalD.toFixed(1)}</span> · <span class="mono">R ${tally.totalR.toFixed(1)}</span> · Majority line <span class="mono">${rules.majorityLine}</span><br/>
      Modeled districts: <span class="mono">${maj.modeled}</span> of <span class="mono">${maj.upSeats}</span> (${maj.missing} missing assumed 50/50)
    `;
  } else {
    seatTitle.textContent = "Projected Governor seats";
    seatPillLabel.textContent = "Leader";
    seatPillText.textContent = (leader==="T") ? "Tie" : `${leader==="D" ? "Dem" : "GOP"} lead`;
    seatFooterText.innerHTML = `
      <span class="mono">D ${tally.totalD.toFixed(1)}</span> · <span class="mono">R ${tally.totalR.toFixed(1)}</span> · Majority line <span class="mono">${rules.majorityLine}</span><br/>
      Base (non-election): D <span class="mono">${rules.baseD}</span> · R <span class="mono">${rules.baseR}</span> · Up: <span class="mono">${rules.total - rules.baseD - rules.baseR}</span>
    `;
  }

  // Legend line
  const baseLine = (rules.baseD || rules.baseR)
    ? `<div>Base: <span class="chip blue mono">D ${rules.baseD}</span> <span class="chip red mono">R ${rules.baseR}</span></div>`
    : ``;

  seatLegend.innerHTML = `
    ${baseLine}
    <div>Projected: <span class="chip blue mono">D ${tally.totalD.toFixed(1)}</span> <span class="chip red mono">R ${tally.totalR.toFixed(1)}</span></div>
  `;
}


/* ---------- Map ---------- */
const svg = d3.select("#map");
let mapFeatures = null;
let pathGen = null;
let gRoot = null;
let zoom = null;


/* mode state */
let MODE = "senate";
let IND_CACHE = { senate:null, governor:null, house:null };
let MAP_KIND = null;          // "states" | "house"
let HOUSE_SVG_TEXT = null;

const segMode = document.getElementById("segMode");

const btnSenate = document.getElementById("btn-senate");
const btnGov    = document.getElementById("btn-governor");
const btnHouse  = document.getElementById("btn-house");

function setSegButtons(mode){
  btnSenate.classList.toggle("active", mode==="senate");
  btnGov.classList.toggle("active", mode==="governor");
  btnHouse.classList.toggle("active", mode==="house");

  btnSenate.setAttribute("aria-selected", mode==="senate");
  btnGov.setAttribute("aria-selected", mode==="governor");
  btnHouse.setAttribute("aria-selected", mode==="house");

  segMode.dataset.mode = mode;
}

async function setMode(mode){
  MODE = mode;
  setSegButtons(mode);

  await ensureMapForMode(mode);

  recolorMap();
  renderBucketTable();
  updateSeatMeter();

  // Small UX copy tweak
  const mapHelp = document.getElementById("mapHelpText");
  if (mapHelp){
    mapHelp.textContent = (mode === "house") ? "Hover a district for details." : "Hover a state for details.";
  }
}

btnSenate.addEventListener("click", ()=>{ setMode("senate").catch(console.error); });
btnGov.addEventListener("click", ()=>{ setMode("governor").catch(console.error); });
btnHouse.addEventListener("click", ()=>{ setMode("house").catch(console.error); });

async function ensureMapForMode(modeKey){
  const want = (modeKey === "house") ? "house" : "states";
  if (MAP_KIND === want) return;

  if (want === "states") await initStateMap();
  else await initHouseMap();

  MAP_KIND = want;
}

async function initStateMap(){
  const topo = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(r=>r.json());
  const geo = topojson.feature(topo, topo.objects.states);
  mapFeatures = geo.features;

  const width = 960;
  const height = 600;
  svg.attr("viewBox", `0 0 ${width} ${height}`);

  const projection = d3.geoAlbersUsa();
  projection.fitExtent([[18, 18], [width - 18, height - 18]], geo);

  pathGen = d3.geoPath(projection);

  svg.selectAll("*").remove();
  gRoot = svg.append("g");

  gRoot.selectAll("path")
    .data(mapFeatures)
    .join("path")
    .attr("class", d => {
      const st = fipsToUsps(d.id);
      const active = st && DATA[MODE].ratios[st];
      return active ? "state active" : "state";
    })
    .attr("data-st", d => fipsToUsps(d.id))
    .attr("d", d => pathGen(d))
    .attr("fill", "#4b5563")
    .on("mouseenter", (event, d)=>{
      const st = fipsToUsps(d.id);
      if (!st) return;
      if (!DATA[MODE].ratios[st]) return;
      d3.select(event.currentTarget).classed("hovered", true);
      showTooltip(event, MODE, st, IND_CACHE[MODE]);
    })
    .on("mousemove", (event, d)=>{
      const st = fipsToUsps(d.id);
      if (!st) return;
      if (!DATA[MODE].ratios[st]) return;
      positionTooltip(event);
    })
    .on("mouseleave", (event)=>{
      d3.select(event.currentTarget).classed("hovered", false);
      hideTooltip();
    });

  recolorMap();
}

async function initHouseMap(){
  const width = 960;
  const height = 600;

  svg.selectAll("*").remove();
  svg.attr("viewBox", `0 0 ${width} ${height}`);
  gRoot = svg.append("g");

  if (!HOUSE_SVG_TEXT){
    HOUSE_SVG_TEXT = await fetch("house.svg", {cache:"no-store"}).then(r=>{
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    });
  }

  const doc = new DOMParser().parseFromString(HOUSE_SVG_TEXT, "image/svg+xml");
  const shapes = doc.getElementById("district-shapes");
  if (!shapes) throw new Error("house.svg missing #district-shapes");

  const imported = document.importNode(shapes, true);
  gRoot.node().appendChild(imported);

  // Tag district geometry for selection/styling
  // (Some SVGs carry their own classes; we only add a stable data-did mapping here.)
  gRoot.selectAll("#district-shapes *").each(function(){
    const rawId = String(this.id || "").trim();
    if (!rawId) return;

    // Normalize: allow "101" -> "0101", allow stray prefixes/suffixes, but only keep it if it's in the ratios table.
    let did = rawId;
    if (!DATA.house.ratios[did]){
      const digits = rawId.replace(/\D/g, "");
      if (digits) did = digits.padStart(4,"0").slice(-4);
    }

    if (!DATA.house.ratios[did]) return;

    this.classList.add("district","active");
    this.setAttribute("data-did", did);

    // Ensure JS-driven fills can override SVG inline style fills.
    try{ this.style.fill = ""; }catch(e){}
    try{ this.style.fillOpacity = ""; }catch(e){}
    try{ this.style.pointerEvents = "all"; }catch(e){}
  });

  // Fit viewBox to the districts
  try{
    const bb = gRoot.node().getBBox();
    const pad = 18;
    svg.attr("viewBox", `${bb.x-pad} ${bb.y-pad} ${bb.width+pad*2} ${bb.height+pad*2}`);
  }catch(e){
    // ignore; keep default viewBox
  }

  // Hover interactions
  gRoot.selectAll(".district")
    .on("mouseenter", (event)=>{
      let did = event.currentTarget.getAttribute("data-did") || event.currentTarget.id || "";
      if (did && !DATA.house.ratios[did]){
        const digits = String(did).replace(/\D/g, "");
        if (digits) did = digits.padStart(4,"0").slice(-4);
      }
      if (!did) return;
      if (!DATA.house.ratios[did]) return;
      d3.select(event.currentTarget).classed("hovered", true);
      showTooltip(event, "house", did, null);
    })
    .on("mousemove", (event)=>{
      let did = event.currentTarget.getAttribute("data-did") || event.currentTarget.id || "";
      if (did && !DATA.house.ratios[did]){
        const digits = String(did).replace(/\D/g, "");
        if (digits) did = digits.padStart(4,"0").slice(-4);
      }
      if (!did) return;
      if (!DATA.house.ratios[did]) return;
      positionTooltip(event);
    })
    .on("mouseleave", (event)=>{
      d3.select(event.currentTarget).classed("hovered", false);
      hideTooltip();
    });

  recolorMap();
}


function recolorMap(){
  if (!gRoot) return;

  if (MAP_KIND === "house"){
    gRoot.selectAll(".district").each(function(){
      const did = this.getAttribute("data-did");
      const ratio = DATA.house.ratios[did];

      if (!ratio){
        this.removeAttribute("display");
        this.style.fill = "#4b5563";
        this.classList.remove("filtered");
        return;
      }

      const model = getHouseModel(did);
      if (!model){
        this.removeAttribute("display");
        this.style.fill = "#4b5563";
        this.classList.add("filtered");
        return;
      }

      const m = marginRD(model.combinedPair);
      this.removeAttribute("display");
      this.classList.remove("filtered");
      this.style.fill = interpColor(m);
    });
    return;
  }

  if (!mapFeatures) return;

  gRoot.selectAll("path.state").each(function(){
    const st = this.getAttribute("data-st");
    const ratio = DATA[MODE].ratios[st];

    // Non-race states stay visible as neutral background.
    if (!ratio){
      this.removeAttribute("display");
      this.style.fill = "#4b5563";
      this.setAttribute("fill", "#4b5563");
      this.classList.remove("active","filtered");
      return;
    }

    this.classList.add("active");

    const model = getStateModel(MODE, st, IND_CACHE[MODE]);
    if (!model){
      this.removeAttribute("display");
      this.style.fill = "#4b5563";
      this.setAttribute("fill", "#4b5563");
      this.classList.add("filtered");
      return;
    }

    const m = marginRD(model.combinedPair);
    this.removeAttribute("display");
    this.classList.remove("filtered");
    this.style.fill = interpColor(m);
  });
}

/* ---------- Bucket table ---------- */
const bucketBody = document.getElementById("bucketBody");
const BUCKET_ORDER = ["Likely D","Lean D","Tossup","Lean R","Likely R"];


function renderBucketTable(){
  if (!bucketBody) return;

  const ratios = DATA[MODE].ratios || {};
  const buckets = {};
  for (const k of BUCKET_ORDER) buckets[k] = [];

  for (const key of Object.keys(ratios)){
    const model = (MODE === "house")
      ? getHouseModel(key)
      : getStateModel(MODE, key, IND_CACHE[MODE]);
    if (!model) continue;

    const m = marginRD(model.combinedPair);
    const bKey = bucketKeyFromMargin(m);
    if (!bKey) continue;

    const absM = Math.abs(m);

    // label/name per chamber
    let label = key;
    let name = key;

    if (MODE === "house"){
      const meta = DATA.house.meta[key] || {};
      label = meta.code || key;
      name = meta.name || label;
    } else {
      label = key;
      name = USPS_TO_NAME[key] || key;
    }

    let cls = "t";
    if (bKey === "Likely D") cls = "ld";
    if (bKey === "Lean D")   cls = "leand";
    if (bKey === "Lean R")   cls = "leanr";
    if (bKey === "Likely R") cls = "lr";

    buckets[bKey].push({ key, label, name, m, absM, cls });
  }

  for (const k of BUCKET_ORDER){
    buckets[k].sort((a,b)=>a.absM - b.absM);
  }

  const maxLen = Math.max(...BUCKET_ORDER.map(k => buckets[k].length), 0);

  if (maxLen === 0){
    bucketBody.innerHTML = `<tr><td colspan="5"><div class="raceEmpty" style="height:72px;justify-content:center;">No competitive races</div></td></tr>`;
    return;
  }

  bucketBody.innerHTML = "";
  for (let i=0; i<maxLen; i++){
    const tr = document.createElement("tr");

    for (const k of BUCKET_ORDER){
      const td = document.createElement("td");
      const item = buckets[k][i];

      if (!item){
        const ph = document.createElement("div");
        ph.className = "raceEmpty";
        td.appendChild(ph);
      } else {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `raceItem ${item.cls}`;
        btn.setAttribute("data-key", item.key);
        btn.title = item.name;

        const top = document.createElement("div");
        top.className = "raceTop";
        top.textContent = item.label;

        const mid = document.createElement("div");
        mid.className = "raceName";
        mid.textContent = item.name;

        const bot = document.createElement("div");
        bot.className = "raceBottom";
        bot.textContent = fmtLead(item.m);

        btn.appendChild(top);
        btn.appendChild(mid);
        btn.appendChild(bot);

        const allSel = (MODE === "house") ? ".district" : "path.state";
        const oneSel = (MODE === "house")
          ? `.district[data-did='${item.key}']`
          : `path.state[data-st='${item.key}']`;

        btn.addEventListener("mouseenter", ()=>{
          const evt = pseudoEvtFromEl(btn);
          showTooltip(evt, MODE, item.key, IND_CACHE[MODE]);
          gRoot?.selectAll(allSel).classed("focus", false);
          gRoot?.selectAll(oneSel).classed("focus", true);
        });
        btn.addEventListener("mouseleave", ()=>{
          hideTooltip();
          gRoot?.selectAll(allSel).classed("focus", false);
        });
        btn.addEventListener("click", ()=>{
          const evt = pseudoEvtFromEl(btn);
          showTooltip(evt, MODE, item.key, IND_CACHE[MODE]);
        });

        td.appendChild(btn);
      }

      tr.appendChild(td);
    }

    bucketBody.appendChild(tr);
  }
}

/* ---------- Boot ---------- */
(async function boot(){
  const ok = await loadCSV();
  if (!ok) return;

  const okHouse = await loadHouseRatios();
  if (!okHouse) return;

  // cache indicators per mode (House intentionally has none)
  IND_CACHE.senate = computeIndicatorNationalFromPolls("senate");
  IND_CACHE.governor = computeIndicatorNationalFromPolls("governor");
  IND_CACHE.house = null;

  // initial mode
  await setMode("senate");
})();
</script>
</body>
</html>
